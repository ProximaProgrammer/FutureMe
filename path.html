<!DOCTYPE html>
<html lang="en" style="background-color: #c7ffaf">

<h id="wolframtitle" style="color: rgb(12, 6, 32); font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif; font-size: 20px; margin-left: 1%; margin-top: 1%">
    Powered by <span style="color: red">Wolfram</span><span style="color: rgb(229, 128, 12)">Alpha</span>â„¢.
</h>

<img src="page2topreal.png" style="width: 45%;max-width: 70vw;height: auto;display: block;margin: 0 auto;">

<head>
    <meta charset="UTF-8">
    <title>Profession Stats</title>
    <style>
      body {
        opacity: 0;
        font-family: sans-serif;
        padding: 20px;
        transition: opacity 2s ease-out;
      }

      body.show {
        opacity: 1;
        font-family: sans-serif;
        padding: 20px;
        transition: opacity 2s ease-out;
      }
  
      .stats {
        text-align: center;
        margin: 50vh 0;
      }
  
      .result {
        margin: 0 0;
        font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        font-size: 25px;
      }
  
      .loading {
        text-align: center;
        font-size: 18px;
      }

      #scrollDownBtn {
        position: fixed;
        top: 50%;
        right: 20px;
        padding: 10px 15px;
        font-size: 20px;
        border-radius: 50%;
        cursor: pointer;
      }
    </style>
    <!-- Load Chart.js properly -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<p id="firstpart" style="color: rgb(2, 39, 17); font-size: 20%; font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif; text-align: center; top: 50vh">
</p>

<button id="scrollDownBtn" style="position: absolute; top: 92%; right: 5%; padding: 3vh 3vw; background-color: rgb(69, 168, 210); color: rgb(246, 245, 250); font-size: 20px; border-radius: 20%; border: 0px">
Next...
</button>

<div class="stats">
    <h1 style="color: rgb(4, 4, 84)">Stats for Profession</h1>
    <div id="professionName"></div>
    <div id="peopleEmployed" class="result">People Employed: <span id="peopleEmployedResult">Loading...</span></div>
    <div id="meanIncome" class="result">Mean Income: <span id="meanIncomeResult">Loading...</span></div>
</div>

<div style="width: 80%; margin: 0 auto;">
    <canvas id="employmentHistoryChart"></canvas>
</div>

<script>
    // Button event listener
    document.getElementById('scrollDownBtn').addEventListener('click', () => {
        window.scrollTo({ top: 0.5*document.body.scrollHeight, behavior: 'smooth' });
    });

    // On load function
    window.onload = function() {
        setTimeout(() => {
            window.scrollTo(0, 20); // Scroll to the top
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 20;
        }, 10); // Small delay to have function scroll-to-top
        document.body.classList.add('show');
        
        // For testing, set a default profession if none exists
        if (!localStorage.getItem("profession")) {
            localStorage.setItem("profession", "Software Developer");
        }
        
        // Set the profession text
        var profession = localStorage.getItem("profession");
        document.getElementById("firstpart").innerText = `Future ${profession}!`;
        document.getElementById("firstpart").style = "color: rgb(2, 39, 13); font-size: 350%; font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif; text-align: center";
        
        // Fetch data for the profession
        fetchProfessionData(profession);
    };

    // Function to parse employment history data
    function parseEmploymentHistoryData(data) {
        console.log("Parsing employment data:", data);
        // Parse the data string into an array of labels (years) and values (number of people employed)
        const lines = data.split('\n');
        const labels = [];
        const values = [];

        lines.forEach(line => {
            const parts = line.split(':');
            if (parts.length === 2) {
                labels.push(parts[0].trim());
                // Make sure we get a number, fallback to 0 if parsing fails
                const value = parseInt(parts[1].trim().replace(/,/g, ''), 10);
                values.push(isNaN(value) ? 0 : value);
            }
        });

        console.log("Parsed data:", { labels, values });
        return { labels, values };
    }

    // Function to render employment history graph
    function renderEmploymentHistoryGraph(data) {
        console.log("Rendering graph with data:", data);
        const ctx = document.getElementById('employmentHistoryChart').getContext('2d');
        const chartData = parseEmploymentHistoryData(data);
        
        // Check if we have data to render
        if (chartData.labels.length === 0 || chartData.values.length === 0) {
            console.log("No valid chart data to render");
            return;
        }

        // Create chart
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Employment History',
                    data: chartData.values,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    fill: false,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Employment History Over Time'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                return `Employment: ${tooltipItem.raw}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Year'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Number of People Employed'
                        }
                    }
                }
            }
        });
    }

    // Function to fetch profession data
    function fetchProfessionData(profession) {
        console.log("Fetching data for profession:", profession);
        const apiKey = 'GVAJ4Q-KJ5QTE2KVL';    
        const queryUrl = `https://api.wolframalpha.com/v2/query?input=${encodeURIComponent(profession + " career statistics")}&format=plaintext&output=json&appid=${apiKey}`;
        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(queryUrl)}`;

        fetch(proxyUrl)
            .then(response => {
                console.log("Received response:", response);
                return response.json();
            })
            .then(data => {
                console.log("Received data:", data);
                let raw = data.contents;

                let parsedData;
                try {
                    parsedData = JSON.parse(raw);
                    console.log("Parsed JSON:", parsedData);
                } catch (err) {
                    console.error('JSON parse failed:', err);
                    document.getElementById('peopleEmployedResult').innerText = 'Error (invalid data)';
                    document.getElementById('meanIncomeResult').innerText = 'Error (invalid data)';
                    return;
                }

                const pods = parsedData.queryresult?.pods || [];
                console.log('Received pods:', pods);

                let peopleEmployed = '';
                let meanIncome = '';
                let employmentHistoryData = null;

                pods.forEach(pod => {
                    const title = pod.title.toLowerCase();
                    const content = pod.subpods?.[0]?.plaintext || '';
                    console.log(`Pod: ${title} - Content: ${content}`);

                    if (title.includes('employment') || title.includes('people employed')) {
                        peopleEmployed = content;
                    }

                    if (title.includes('mean income') || title.includes('mean wage') || title.includes('median wage') || title.includes('average income') || title.includes('wage')) {
                        meanIncome = content;
                    }

                    // Find employment history data
                    if (title.includes('employment history')) {
                        console.log('Employment history found:', content);
                        employmentHistoryData = content;
                    }
                });

                // Update display elements
                document.getElementById('peopleEmployedResult').innerText = peopleEmployed || 'Not available';
                document.getElementById('meanIncomeResult').innerText = meanIncome || 'Not available';

                // Render graph if we have data
                if (employmentHistoryData) {
                    renderEmploymentHistoryGraph(employmentHistoryData);
                } else {
                    console.log('No employment history data found.');
                }
            })
            .catch(err => {
                console.error('Fetch error:', err);
                document.getElementById('peopleEmployedResult').innerText = 'Fetch error';
                document.getElementById('meanIncomeResult').innerText = 'Fetch error';
            });
    }
</script>
</body>
</html>
