<!DOCTYPE html>
<html lang="en" style="background-color: #c7ffaf">
<head>
    <meta charset="UTF-8">
    <title>Profession Stats Data Table</title>
    <style>
        body {
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            padding: 20px;
            opacity: 0.9;
            transition: opacity 1s ease-out;
        }
        
        body.show {
            opacity: 1;
        }
        
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        #wolframtitle {
            color: rgb(12, 6, 32);
            font-size: 20px;
            margin-right: auto;
        }
        
        .profession-title {
            color: rgb(2, 39, 13);
            font-size: 32px;
            text-align: center;
            margin: 30px 0;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .data-table th {
            background-color: rgb(4, 4, 84);
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .data-table tr:hover {
            background-color: #205b06;
            color: white;
        }
        
        .chart-container {
            width: 100%;
            height: 400px;
            margin: 30px 0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
        }
        
        .data-source {
            text-align: right;
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="header">
        <div id="wolframtitle">
            Powered by <span style="color: red">Wolfram</span><span style="color: rgb(229, 128, 12)">Alpha</span>â„¢
        </div>
    </div>

    <h1 class="profession-title" id="professionTitle">Profession Statistics</h1>
    
    <table class="data-table" id="statsTable">
        <thead>
            <tr>
                <th>Category</th>
                <th>Value</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Profession</td>
                <td id="professionName">Loading...</td>
                <td>Primary occupation title</td>
            </tr>
            <tr>
                <td>People Employed</td>
                <td id="peopleEmployedResult">Loading...</td>
                <td>Total number of professionals in this field</td>
            </tr>
            <tr>
                <td>Mean Income</td>
                <td id="meanIncomeResult">Loading...</td>
                <td>Average annual salary</td>
            </tr>
            <tr>
                <td>Employment Growth</td>
                <td id="growthResult">Loading...</td>
                <td>Year-over-year change in employment</td>
            </tr>
            <tr>
                <td>Field Classification</td>
                <td id="fieldClassResult">Loading...</td>
                <td>General career category</td>
            </tr>
        </tbody>
    </table>
    
    <div class="chart-container">
        <canvas id="employmentHistoryChart"></canvas>
    </div>
    
    <div class="data-source">
        Data source: Wolfram Alpha API
    </div>

    <script>
        // On load function
        window.onload = function() {
            document.body.classList.add('show');
            
            // For testing, set a default profession if none exists
            if (!localStorage.getItem("profession")) {
                localStorage.setItem("profession", "Software Developer");
            }
            
            // Set the profession text
            var profession = localStorage.getItem("profession");
            document.getElementById("professionName").innerText = profession;
            document.getElementById("professionTitle").innerText = `Statistics for ${profession}`;
            
            // Fetch data for the profession
            fetchProfessionData(profession);
        };

        // Function to create a placeholder employment history based on profession
        function createMockEmploymentHistory(profession, peopleEmployed) {
            const currentYear = new Date().getFullYear();
            const years = [];
            const values = [];
        
            for (let i = 10; i >= 0; i--) {
                years.push(currentYear - i);
                values.push(10000);
            }
        
            return { labels: years, values: values };
        }

        // Function to render employment history graph
        function renderEmploymentHistoryGraph(data, profession, peopleEmployed) {
            const ctx = document.getElementById('employmentHistoryChart').getContext('2d');
            let chartData;
            let unavailable = false;
            
            if (data && typeof data === 'string') {
                // Try to parse real data if we have it
                chartData = parseEmploymentHistoryData(data);
            } else {
                // Create mock data if we don't have real data
                chartData = createMockEmploymentHistory(profession, peopleEmployed);
                unavailable = true;
            }
            
            // Make sure we have data to render
            if (!chartData || chartData.labels.length === 0 || chartData.values.length === 0) {
                chartData = createMockEmploymentHistory(profession, peopleEmployed);
                unavailable = true;
            }

            // Calculate growth rate for the table
            if (chartData.values.length >= 2) {
                const latestYear = chartData.values[chartData.values.length - 1];
                const previousYear = chartData.values[chartData.values.length - 2];
                const growthRate = ((latestYear - previousYear) / previousYear * 100).toFixed(1);
                
                document.getElementById('growthResult').innerText = `${growthRate}%`;
            } else {
                document.getElementById('growthResult').innerText = 'Not available';
            }

            // Create chart
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Employment History',
                        data: chartData.values,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3 // Smooth curve
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Employment History for ${profession} ${unavailable ? "[Actual History Unavailable]" : ""}`,
                            font: {
                                size: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Employed: ${context.raw.toLocaleString()}`;
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of People Employed'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'k';
                                    }
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Function to parse employment history data
        function parseEmploymentHistoryData(data) {
            try {
                // Parse the data string into an array of labels (years) and values (number of people employed)
                const lines = data.split('\n');
                const labels = [];
                const values = [];

                lines.forEach(line => {
                    const parts = line.split(':');
                    if (parts.length === 2) {
                        labels.push(parts[0].trim());
                        // Make sure we get a number, fallback to 0 if parsing fails
                        const value = parseInt(parts[1].trim().replace(/,/g, ''), 10);
                        values.push(isNaN(value) ? 0 : value);
                    }
                });

                return { labels, values };
            } catch (e) {
                console.error("Error parsing employment data:", e);
                return null;
            }
        }

        // Determine field classification based on profession name
        function determineFieldClassification(profession) {
            const profLower = profession.toLowerCase();
            
            if (profLower.includes('develop') || profLower.includes('program') || 
                profLower.includes('engineer') || profLower.includes('tech')) {
                return 'Technology';
            } else if (profLower.includes('doctor') || profLower.includes('nurse') || 
                      profLower.includes('health') || profLower.includes('medical')) {
                return 'Healthcare';
            } else if (profLower.includes('teach') || profLower.includes('educat') || 
                      profLower.includes('professor')) {
                return 'Education';
            } else if (profLower.includes('lawyer') || profLower.includes('attorney') || 
                      profLower.includes('legal')) {
                return 'Legal';
            } else if (profLower.includes('finance') || profLower.includes('account') || 
                      profLower.includes('bank')) {
                return 'Finance';
            } else {
                return 'General Professional';
            }
        }

        // Function to fetch profession data
        function fetchProfessionData(profession) {
            const apiKey = 'GVAJ4Q-KJ5QTE2KVL';    
            // Use more specific query to target career information
            const queryUrl = `https://api.wolframalpha.com/v2/query?input=${encodeURIComponent(profession + " career statistics")}&format=plaintext&output=json&appid=${apiKey}`;
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(queryUrl)}`;

            // Set field classification
            document.getElementById('fieldClassResult').innerText = determineFieldClassification(profession);

            fetch(proxyUrl)
                .then(response => response.json())
                .then(data => {
                    let raw = data.contents;
                    let parsedData;
                    
                    try {
                        parsedData = JSON.parse(raw);
                    } catch (err) {
                        document.getElementById('peopleEmployedResult').innerText = 'Data unavailable';
                        document.getElementById('meanIncomeResult').innerText = 'Data unavailable';
                        document.getElementById('growthResult').innerText = 'Data unavailable';
                        renderEmploymentHistoryGraph(null, profession, null);
                        return;
                    }

                    const pods = parsedData.queryresult?.pods || [];
                    let peopleEmployed = '';
                    let meanIncome = '';
                    let employmentHistoryData = null;

                    pods.forEach(pod => {
                        const title = pod.title.toLowerCase();
                        const content = pod.subpods?.[0]?.plaintext || '';

                        if (title.includes('employment') || title.includes('people employed')) {
                            peopleEmployed = content;
                        }

                        if (title.includes('mean income') || title.includes('mean wage') || 
                            title.includes('median wage') || title.includes('average income') || 
                            title.includes('wage')) {
                            meanIncome = content;
                        }

                        // Find employment history data
                        if (title.includes('employment history')) {
                            employmentHistoryData = content;
                        }
                    });

                    // Update display elements
                    document.getElementById('peopleEmployedResult').innerText = peopleEmployed || 'Data unavailable';
                    document.getElementById('meanIncomeResult').innerText = meanIncome || 'Data unavailable';

                    // Always render graph, using real data if available or mock data if not
                    renderEmploymentHistoryGraph(employmentHistoryData, profession, peopleEmployed);
                })
                .catch(err => {
                    document.getElementById('peopleEmployedResult').innerText = 'Unable to fetch data';
                    document.getElementById('meanIncomeResult').innerText = 'Unable to fetch data';
                    document.getElementById('growthResult').innerText = 'Unable to fetch data';
                    renderEmploymentHistoryGraph(null, profession, null);
                });
        }
    </script>
</body>
</html>
